<style type="text/css">
    #search {
        height: 100%;
    }

    #search > div {
        display: flex;
        flex-direction: column;
        height: 100%;
        margin-top: -50px;
        justify-content: center;
    }

    .hotel_result {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
    }

    .hotel_info {
        flex: 1;
        margin-left: 20px;
    }

    .hotel_name {
        font-size: 18px;
        color: #01579B;
    }

    .hotel_addr {
        font-size: 12px;
        color: gray;
    }

    .hotel_tags {
        font-size: 18px;
    }
</style>

<div id="loading-inline">
    <i class="fa fa-refresh fa-5x fa-spin"></i>
</div>
<div class="page" id="search">
    <div>
        <div class="title">你要去哪儿？</div>
        <div class="form-inline">
            <select id="select_city" class="form-control"></select>
            <select id="select_area" class="form-control"></select>
            <button id="btn_search" type="button" class="btn btn-primary">
                <i class="fa fa-lg fa-search"></i> 搜索酒店
            </button>
        </div>
    </div>
</div>
<div class="page" id="result">
    <div id="result_container">
    </div>
</div>

<script type="text/javascript">
    (function () {
        var openPage = function (page) {
            $('#loading-inline').fadeOut(200, function () {
                $(page).fadeIn(200);
            });
        };
        // ----- Page: search -----
        // load areas
        app.view.loadAreas($('#select_city'), $('#select_area'), function () {
            openPage('#search');
        });
        // search
        var results = [];
        $('#btn_search').click(function () {
            $('#search').fadeOut(200, function () {
                $('#loading-inline').fadeIn(200, function () {
                    app.requests.post('HotelBL/search', [$('#select_area').val()], function (resp) {
                        results = resp;
                        for (var key in resp) {
                            var hotel = resp[key];
                            // calculate average rank
                            hotel.avg_rank = 0.0;
                            if (hotel.ranks.length > 0) {
                                hotel.avg_rank = hotel.ranks.map(function (a) { return a.rank; })
                                        .reduce(function (a, b) { return a + b; }) / hotel.ranks.length;
                            }
                            // process orders
                            var tags = '';
                            if (hotel.orders.length > 0) {
                                tags += '<span class="label label-primary">我预定过</span> ';
                                // calculate undo & delayed count
                                var undo_count = hotel.orders.filter(function (a) { return a.state == 'UNDO'; }).length,
                                    delayed_count = hotel.orders.filter(function (a) { return a.state == 'DELAYED'; }).length,
                                    normal_count = hotel.orders.length - undo_count - delayed_count;
                                if (normal_count > 0) {
                                    tags += '<span class="label label-success">正常订单 ' + normal_count + '</span> ';
                                }
                                if (delayed_count > 0) {
                                    tags += '<span class="label label-danger">异常订单 ' + delayed_count + '</span> ';
                                }
                                if (undo_count > 0) {
                                    tags += '<span class="label label-warning">撤销订单 ' + undo_count + '</span> ';
                                }
                            }
                            $('#result_container').append('<div class="hotel_result" data-key="' + key + '">\
                                <div><i class="fa fa-5x fa-building-o"></i></div>\
                                <div class="hotel_info">\
                                    <div class="hotel_name">' + hotel.name + '</div>\
                                    <div class="hotel_addr">' + hotel.address + '</div>\
                                    <div class="hotel_rank">' + hotel.avg_rank.toFixed(1) + ' / 5.0</div>\
                                    <div class="hotel_tags">\
                                        <span class="label label-default">' + hotel.star + '</span> ' + tags + '\
                                    </div>\
                                </div>\
                                <div></div>\
                                <div></div>\
                            </div>');
                        }
                        openPage('#result');
                    }, function () {
                        app.view.showError('搜索酒店失败: 发生网络通信错误');
                    });
                });
            });
        });
    })();
</script>